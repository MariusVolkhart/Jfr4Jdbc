# Jfr4Jdbc

## 動作環境
- JDBC 4.3 準拠
- OpenJDK 11 以降

## Jfr4Jdbc とは
Jfr4Jdbc はデータベースサーバの種類を問わず利用できる JDBC のラッパーライブラリです。
Jfr4Jdbc を使うとユーザはシステムの性能問題が Java アプリケーションとデータベースのどちらで起きているか簡単に分かるようになります。

Jfr4Jdbc は JDBC に対する操作をイベントとして JDK Flight Recorder (JFR) に記録します。
この記録にかかる負荷はわずかです。
ユーザは JFR をダンプし、そのダンプファイルを JDK Mission Control で開くと GUI でデータベース操作を確認できます。
これによってユーザは全てのデータベース処理の問題点をグラフィカルに解析できるようになります。

ユーザは JFR が有効になっているアプリケーションで、Jfr4Jdbc を依存関係に追加し、接続文字列に`jfr:`を追加するだけです。
一部のフレームワークでは依存関係を足すだけで使えます。
一部のデータベース接続だけを分析する場合には、Jfr4Jdbcのデータソースやコネクションオブジェクトを作成し、分析したい JDBC オブジェクトをラップします。

## なにが見られるか

Jfr4Jdbc を使用するとスレッドが処理しているうち、どの時間にデータベースに対する処理をしているかが分かるようになります。
この機能によって接続、ステートメントの実行、コミットなどデータベースに対する操作のうちどの処理に時間が掛かっているかを視覚的に判断できます。
![スレッドレーン](img/ThreadLane.png)

Jfr4Jdbc を使用すると、コネクションがどれだけ使用されていて、どれくらいの数のスレッドがコネクションの割り当て待ちで処理が止まっているかを解析できます。
これはデータソースに所属しているコネクションはデータソースごとにグループ化されます。
これによって、どのコネクションプールが不足しているか、どのデータベースへの接続に時間が掛かっているかを特定できます。
![リソース使用量](img/ConResource.png)

## 記録されるイベント

Jfr4Jdbc では下記のイベントが記録されます。

- コネクションの接続
- コネクションのクローズ
- ステートメント
- 結果セット
- コミット
- ロールバック
- キャンセル
- 接続の割り当て待ち

## 使用方法

- [SpringBootとの統合](doc/SpringJPA_jp.md)
- [Quarkusとの統合](doc/Quarkus_jp.md)
- [特定の処理だけで使う方法](doc/Wrap_jp.md)
